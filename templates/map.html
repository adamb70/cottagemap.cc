<!DOCTYPE html>
<html style="width: 100%; height: 100%;" lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script type="text/javascript">
		const REGIONS = JSON.parse({{ regions|tojson }});
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css" rel="stylesheet">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet'/>

    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.css' type='text/css' />


    <title>Cottage Map</title>


    <style>
        .marker {
            background-image: url('{{ url_for('static', filename='map-icon.png') }}');
            background-size: cover;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        .mapboxgl-popup {
            max-height: 80vh;
            max-width: 280px !important;
        }

        .mapboxgl-popup-content {
            text-align: center;
            font-family: 'Open Sans', sans-serif;
            overflow-y: auto;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1), 0 1px 40px -4px rgba(0, 0, 0, 0.08) !important;
            margin: 3px 0;
            padding: 10px;
        }

        .cottage-title {
            margin: 5px 0 10px;
        }

        .cottage-title a {
            color: #080808
        }

        .location {
            color: #3e319e;
            font-size: 1.05em;
            text-decoration: none;
        }

        .location i {
            margin-right: 0.5em;
        }

        .weekly-price {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .description {
            margin: 5px 0;
        }

        .details {
            font-size: 1.1em;
            color: #222222;
        }

        .details .fa-times {
            color: #dd2928;
        }

        .details .fa-check {
            color: #63d64f;
        }

        .details i {
            margin: 0 0.2em;
        }

        .details .detail-divider {
            margin: 0 0.3em;
        }

        .deal-box {
            background-color: #d26660;
            overflow: unset;
            padding: 10px;
            color: #fff;
            text-decoration: none;
        }

        .deal-box span {
            font-weight: 500;
        }

        .mapboxgl-popup-tip {
            margin: -3px;
        }

        .mapboxgl-popup-close-button {
            font-size: 25px;
        }

        .popup-img {
            max-width: 100%;
        }

        /* disable for debugging */
        .marker {
            background-color: transparent !important;
        }

        .northeastengland {
            background-color: hsla(0, 50%, 50%, 0.3);
        }

        .northwestengland {
            background-color: hsla(70, 97%, 57%, 0.3);
        }

        .centralengland {
            background-color: hsla(197, 53%, 49%, 0.3);
        }

        .northwales {
            background-color: hsla(299, 33%, 63%, 0.3);
        }

        .southwales {
            background-color: hsla(50, 100%, 50%, 0.3);
        }

        .easterncentralengland {
            background-color: hsla(0, 73%, 51%, 0.3);
        }

        .eastanglia {
            background-color: hsla(0, 0%, 13%, 0.3);
        }

        .southwestengland {
            background-color: hsla(33, 72%, 39%, 0.3);
        }

        .southeastengland {
            background-color: hsla(185, 100%, 55%, 0.3);
        }

        .southwestscotland {
            background-color: hsla(9, 100%, 78%, 0.3);
        }

        .southeastscotland {
            background-color: hsla(250, 42%, 56%, 0.3);
        }

        .westcentralscotland {
            background-color: hsla(242, 100%, 50%, 0.3);
        }

        .eastcentralscotland {
            background-color: hsla(113, 100%, 37%, 0.3);
        }

        .scottishhighlands {
            background-color: hsla(186, 100%, 87%, 0.3);
        }

        .northernireland {
            background-color: hsla(125, 50%, 50%, 0.3);
        }
    </style>


</head>
<body style="width: 100%; height: 100%; margin: 0;">


<div id='map' style='width: 100%; height: 100%;'></div>
<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoiYWJsaW5kbWFuIiwiYSI6ImNqcmY1ZDd6cDBydWQ0M3A4OHJ4b2czZGwifQ.brwgWx9jn2ut0PAOqEookQ';
	const map = new mapboxgl.Map({
		container: 'map',
		//style: 'mapbox://styles/mapbox/light-v10',
		style: 'mapbox://styles/mapbox/cj4k8wmwy5lbt2smsigkbh18e',
		//style: 'mapbox://styles/mapbox/cjvshts5l1et01coz11pa6jam',
		center: [-3.953423, 54.312727],
		zoom: 5,
	});

	// Add zoom control
	map.addControl(new mapboxgl.NavigationControl());

	// Add geolocate control to the map.
	map.addControl(new mapboxgl.GeolocateControl({
		positionOptions: {
			enableHighAccuracy: true
		},
		trackUserLocation: true
	}));

	// Add text search
	map.addControl(new MapboxGeocoder({
		accessToken: mapboxgl.accessToken,
		countries: 'gb',
		mapboxgl: mapboxgl
	}), 'top-left');

	const format_boolean = function (bool) {
		return bool ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'
	};

	const resize = function (container) {
		// make sure dimensions are always even number and not a float, to avoid blurry text
		let newWidth = container.offsetWidth;
		if (container.offsetWidth % 2 !== 0)
			newWidth++;
		container.style.width = newWidth + 'px';
		container.style.maxWidth = newWidth + 'px';

		let newHeight = container.offsetHeight;
		if (container.offsetHeight % 2 !== 0)
			newHeight++;
		container.style.height = newHeight + 'px';
		container.style.maxHeight = newHeight + 'px';
	};

	const generate_markers = function (region) {
		const generated_makers = [];
		const processed_lnglats = {};
		for (let cottage of REGIONS[region]) {

			// create a HTML element for each feature
			let el = document.createElement('div');
			el.classList.add('marker', region);

			let lnglat = new mapboxgl.LngLat(cottage.lon, cottage.lat);
			let offset_mult = 0;
			if (lnglat in processed_lnglats) {
				offset_mult = ++processed_lnglats[lnglat];
				// offset lnglat a little bit if markers are on the same coordinates
				lnglat = new mapboxgl.LngLat(parseFloat(cottage.lon) + (0.0001 * offset_mult), parseFloat(cottage.lat) - (0.0001 * offset_mult));
			} else {
				processed_lnglats[lnglat] = 0
			}


			let new_marker = new mapboxgl.Marker(el)
				.setLngLat(lnglat)
				.setPopup(new mapboxgl.Popup({offset: 25})
					.on('open', function (pop) {
						const _container = pop.target._container;

						// set image url
						let img = _container.getElementsByClassName('popup-img')[0];
						// wait until image dimensions are available
						img.src = cottage.image;
						let wait = setInterval(function () {
							let w = img.naturalWidth,
								h = img.naturalHeight;
							if (w && h) {
								clearInterval(wait);
								// resize container
								resize(_container);
							}
						}, 30);

						// attach late deals
						for (let offer of cottage.late_offers) {
							let deal_box = document.createElement('a');
							deal_box.classList.add('deal-box', 'mapboxgl-popup-content');
							deal_box.href = cottage.url + '#last-minute-offers';
							deal_box.target = cottage.ref;
							deal_box.innerHTML = '<span>Offer: </span>' + offer.offer;
							_container.appendChild(deal_box);
						}

						// center on marker
						let marker_rect = el.getBoundingClientRect();
						let marker_center = marker_rect.top + (marker_rect.height / 2);
						let offset_sign = -1;
						if (marker_center > window.innerHeight / 2) {
							offset_sign = 1;
						}
						map.flyTo({center: this.getLngLat(), offset: [0, window.innerHeight * 0.4 * offset_sign]});

					})
					.setHTML('<h3 class="cottage-title"><a href="' + cottage.url + '" target="' + cottage.ref + '">' + cottage.title + '</a></h3>'
						+ '<a href="https://www.google.com/maps/search/?api=1&query=' + cottage.lat + ',' + cottage.lon
						+ '" class="location" title="View on Google Maps" target="' + cottage.ref + '_map"><i class="fas fa-map-marker-alt"></i>'
						+ cottage.location + '</a><p class="description">' + cottage.description
						+ '</p><div class="weekly-price">Weekly price £' + cottage.weekly_low + ' to £' + cottage.weekly_high
						+ '</div><a href="' + cottage.url + '" target="' + cottage.ref + '"><img class="popup-img" src=""/></a><div class="details">'
						+ '<i class="fas fa-bed" title="Sleeps"></i> ' + cottage.sleeps + '<span class="detail-divider">|</span><i class="fas fa-door-open" title="Bedrooms"></i> ' +
						cottage.bedrooms + '<span class="detail-divider">|</span><i class="fas fa-dog" title="Dogs allowed"></i>' + format_boolean(cottage.dog) +
						'<span class="detail-divider">|</span><i class="fas fa-child" title="Child friendly"></i>' + format_boolean(cottage.child) +
						'<span class="detail-divider">|</span><i class="fas fa-wifi" title="Wifi"></i>' + format_boolean(cottage.wifi)))
				.addTo(map);

			generated_makers.push(new_marker);
		}
		return generated_makers
	};

	const genereate_all_markers = function () {
		for (const region in REGIONS) {
			REGION_MARKERS[region] = generate_markers(region);
		}
	};

	const delete_region_markers = function (region) {
		for (const marker of REGION_MARKERS[region]) {
			marker.remove();
		}
		delete REGION_MARKERS[region]
	};

	const delete_all_markers = function () {
		for (const region in REGIONS) {
			delete_region_markers(region);
		}
	};


	// init markers
	const REGION_MARKERS = {};
	genereate_all_markers();

</script>


</body>
</html>